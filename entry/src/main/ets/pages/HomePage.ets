/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { CommonConstants as Const } from '../common/constants/CommonConstants';
import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import ClassifyComponent from '../view/ClassifyComponent';
import SearchComponent from '../view/SearchComponent';
import SwiperComponent from '../view/SwiperComponent';
import WaterFlowComponent from '../view/WaterFlowComponent';
import UserIconComponent from '../userprofile/view/UserIconComponent';
import { DatabaseManager, ProductRow } from '../userprofile/database/DatabaseManager';
import Logger from '../common/utils/Logger';
import { waterFlowData } from '../viewmodel/HomeViewModel';
import { productSeeds, getProductImage, seedProductsAsItems } from '../viewmodel/ProductSeeds';
import { IProductItem } from '../viewmodel/ProductItem';

const TAG = 'HomePage';

/**
 * The home page consists of four components: search component,
 * classify component, swiper component, and waterfall flow component.
 * How to use: These four components are invoked where the control is used.
 */
@Entry
@Component
struct HomePage {
  @StorageLink('topRectHeight') topRectHeight: number = 0;
  @State selectedCategory: number = 0;
  @State filteredProductData: IProductItem[] = seedProductsAsItems();
  @State searchKeyword: string = '';
  private lastCategory: number = -1; // è·Ÿè¸ªä¸Šä¸€æ¬¡çš„åˆ†ç±»
  private context = getContext(this) as common.UIAbilityContext;
  private dbManager: DatabaseManager = DatabaseManager.getInstance();

  async aboutToAppear(): Promise<void> {
    // åˆå§‹åŒ–æ•°æ®åº“
    try {
      await this.dbManager.initDatabase(this.context);
      await this.dbManager.initProducts(productSeeds);
    } catch (err) {
      const error = err as Error;
      Logger.error(TAG, `æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
    }
    // åˆå§‹åŒ–å•†å“æ•°æ®
    this.lastCategory = this.selectedCategory;
    await this.updateFilteredProducts(this.selectedCategory);
  }

  aboutToUpdate(): void {
    // åªåœ¨åˆ†ç±»çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°è¿‡æ»¤åçš„å•†å“æ•°æ®
    if (this.lastCategory !== this.selectedCategory) {
      Logger.info(TAG, `åˆ†ç±»ä» ${this.lastCategory} å˜ä¸º ${this.selectedCategory}`);
      this.lastCategory = this.selectedCategory;
      this.updateFilteredProducts(this.selectedCategory).catch((err: Error) => {
        Logger.error(TAG, `æ›´æ–°è¿‡æ»¤å•†å“å¤±è´¥: ${err.message}`);
      });
    }
  }

  /**
   * æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»æ›´æ–°è¿‡æ»¤åçš„å•†å“æ•°æ®
   */
  async updateFilteredProducts(categoryId?: number, keyword?: string): Promise<void> {
    const targetCategory = categoryId !== undefined ? categoryId : this.selectedCategory;
    Logger.info(TAG, `æ›´æ–°è¿‡æ»¤å•†å“ï¼Œåˆ†ç±»: ${targetCategory}, å…³é”®è¯: ${keyword ?? ''}`);
    Logger.info(TAG, `æ›´æ–°å‰ filteredProductData é•¿åº¦: ${this.filteredProductData.length}`);

    let newData: IProductItem[];

    try {
      const rows: ProductRow[] = await this.dbManager.getProducts(targetCategory, keyword);
      newData = rows.map((row: ProductRow): IProductItem => {
        const imageRes = getProductImage(row.imageKey);
        return {
          image_url: imageRes,
          name: row.name,
          discount: row.discount,
          price: row.price,
          promotion: row.promotion,
          bonus_points: row.bonus_points,
          category: row.category
        };
      });
      Logger.info(TAG, `DB æŸ¥è¯¢åå…± ${newData.length} ä¸ªå•†å“`);
    } catch (err) {
      const error = err as Error;
      Logger.error(TAG, `æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${error.message}ï¼Œå›é€€åˆ°é™æ€æ•°æ®`);
      if (targetCategory === 0) {
        newData = [...waterFlowData];
      } else {
        newData = waterFlowData.filter((item: IProductItem) => item.category === targetCategory);
      }
    }

    // å¼ºåˆ¶åˆ›å»ºæ–°æ•°ç»„å¼•ç”¨ï¼Œç¡®ä¿ ArkTS æ£€æµ‹åˆ°å˜åŒ–
    this.filteredProductData = newData;
    Logger.info(TAG, `æ›´æ–°å filteredProductData é•¿åº¦: ${this.filteredProductData.length}`);
    Logger.info(TAG, `æ•°ç»„å¼•ç”¨æ˜¯å¦æ”¹å˜: ${newData !== waterFlowData}`);
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($r('app.media.ic_app_background'))
        .width(Const.FULL_WIDTH)
        .height($r('app.float.image_background_height'))
        .objectFit(ImageFit.Cover)
        .position({ x: 0, y: 0 }) // è´´é¡¶å±•ç¤ºèƒŒæ™¯
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ ï¼šæœç´¢æ¡†å’Œä¸ªäººä¿¡æ¯å…¥å£
        Row() {
          SearchComponent({
            onSearchChange: async (kw: string) => {
              this.searchKeyword = kw;
              await this.updateFilteredProducts(this.selectedCategory, this.searchKeyword);
            },
            onSearch: async () => {
              await this.updateFilteredProducts(this.selectedCategory, this.searchKeyword);
            }
          })
            .layoutWeight(1)
          // ä¸ªäººä¿¡æ¯å…¥å£æŒ‰é’® - åœ†å½¢å›¾æ ‡åŠ æ–‡å­—
          UserIconComponent({
            iconColor: $r('app.color.profile_icon_color'),
            iconSize: 40,
            text: 'æˆ‘'
          })
          .shadow({
            radius: 4,
            color: '#15000000',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ left: $r('app.float.profile_icon_margin_left') })
          .onClick(async () => {
            try {
              // æ£€æŸ¥ç™»å½•çŠ¶æ€
              const currentUser = await this.dbManager.getCurrentUser();
              if (currentUser) {
                // å·²ç™»å½•ï¼Œè·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µ
                router.pushUrl({
                  url: 'userprofile/pages/ProfilePage'
                }).catch((err: Error) => {
                  Logger.error(TAG, `è·³è½¬ä¸ªäººä¿¡æ¯é¡µå¤±è´¥: ${err.message}`);
                });
              } else {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                router.pushUrl({
                  url: 'userprofile/pages/LoginPage'
                }).catch((err: Error) => {
                  Logger.error(TAG, `è·³è½¬ç™»å½•é¡µå¤±è´¥: ${err.message}`);
                });
              }
            } catch (err) {
              const error = err as Error;
              Logger.error(TAG, `æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ${error.message}`);
              // å‡ºé”™æ—¶ä¹Ÿè·³è½¬åˆ°ç™»å½•é¡µ
              router.pushUrl({
                url: 'userprofile/pages/LoginPage'
              }).catch((err: Error) => {
                Logger.error(TAG, `è·³è½¬ç™»å½•é¡µå¤±è´¥: ${err.message}`);
              });
            }
          })
        }
        .width(Const.FULL_WIDTH)
        .alignItems(VerticalAlign.Center)
        ClassifyComponent({ 
          selectedCategory: $selectedCategory,
          onCategoryChange: (category: number) => {
            Logger.info(TAG, `åˆ†ç±»å˜åŒ–å›è°ƒï¼Œåˆ†ç±»: ${category}, å½“å‰selectedCategory: ${this.selectedCategory}`);
            // åŒæ­¥çŠ¶æ€å¹¶ç«‹åˆ»æŒ‰æœ€æ–°åˆ†ç±»è¿‡æ»¤ï¼Œé¿å…è¯»åˆ°æ—§å€¼
            this.selectedCategory = category;
            this.updateFilteredProducts(category, this.searchKeyword);
          }
        })
        SwiperComponent()
        WaterFlowComponent({ productData: this.filteredProductData })
          .layoutWeight(1)
      }
      .padding({
        left: $r('app.float.home_margin_left'),
        right: $r('app.float.home_margin_right'),
        top: this.getUIContext().px2vp(this.topRectHeight)
      })
      .align(Alignment.TopStart) // é¡¶éƒ¨å¯¹é½
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Start)
      
      // AIå®¢æœæŒ‰é’®ï¼ˆå›ºå®šåœ¨çª—å£å³ä¸‹è§’ï¼‰
      Column() {
        Text('ğŸ’¬')
          .fontSize(24)
      }
      .width(56)
      .height(56)
      .backgroundColor('#FF8A3C')
      .borderRadius(28)
      .shadow({
        radius: 8,
        color: 'rgba(255,138,60,0.4)',
        offsetX: 0,
        offsetY: 4
      })
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .position({ x: '100%', y: '100%' }) // ç»å¯¹å®šä½åˆ°å³ä¸‹è§’
      .markAnchor({ x: 56 + 16, y: 56 + 16 }) // é”šç‚¹åç§»ï¼šå®½åº¦+å³è¾¹è·, é«˜åº¦+ä¸‹è¾¹è·
      .zIndex(999) // æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚
      .onClick(() => {
        router.pushUrl({
          url: 'userprofile/pages/AiServicePage'
        }).catch((err: Error) => {
          Logger.error(TAG, `è·³è½¬AIå®¢æœé¡µé¢å¤±è´¥: ${err.message}`);
        });
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.home_background_color'))
  }
  @Builder
  buildActivityBanner() {}

}
