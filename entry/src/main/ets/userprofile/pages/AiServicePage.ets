/*
 * AI Customer Service Page (Modern Chat UI)
 */
import { CommonConstants as Const } from '../../common/constants/CommonConstants';
import promptAction from '@ohos.promptAction';
import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';

class ChatMessage {
  content: ResourceStr = '';
  isSelf: boolean = false;
  timestamp?: string;
}

@Entry
@Component
struct AiServicePage {
  // é¢„ç½®å‡ æ¡æ¶ˆæ¯ï¼Œé¿å…è¿›æ¥ç©ºè¡è¡
  @State messages: ChatMessage[] = [
    { content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±žAIå®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ', isSelf: false },
    { content: 'æˆ‘æƒ³æŸ¥è¯¢ä¸€ä¸‹æˆ‘çš„ä¼šå‘˜ç§¯åˆ†æ˜Žç»†ã€‚', isSelf: true },
    { content: 'æ²¡é—®é¢˜ï¼Œæ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢ï¼Œè¯·ç¨å€™...', isSelf: false }
  ];
  @State inputText: string = '';
  // æ»šåŠ¨æŽ§åˆ¶å™¨ï¼Œç”¨äºŽå‘é€æ¶ˆæ¯åŽè‡ªåŠ¨æ»šåˆ°åº•éƒ¨
  private scroller: Scroller = new Scroller();

  @StorageLink('topRectHeight') topRectHeight: number = 0;

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ  (ä»¿å¾®ä¿¡/é€šç”¨Appé£Žæ ¼)
      Row() {
        // è¿”å›žæŒ‰é’®
        Row() {
          Text('â®') // Unicode ç®­å¤´æ›¿ä»£å›¾æ ‡
            .fontSize(20)
            .fontColor('#333333')
            .fontWeight(FontWeight.Bold)
        }
        .height('100%')
        .aspectRatio(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .onClick(() => {
          try {
            router.back();
          } catch (err) {
            console.error(`Router back failed: ${(err as BusinessError).message}`);
          }
        })

        // æ ‡é¢˜
        Text($r('app.string.ai_service_title')) // ç¡®ä¿ string.json ä¸­æœ‰è¿™ä¸ª keyï¼Œæˆ–è€…ç›´æŽ¥å†™å­—ç¬¦ä¸² 'æ™ºèƒ½å®¢æœ'
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .padding({ right: 40 }) // ä¸ºäº†è®©æ ‡é¢˜è§†è§‰å±…ä¸­ï¼ˆæŠµæ¶ˆå·¦ä¾§è¿”å›žé”®å®½åº¦ï¼‰
      }
      .width('100%')
      .height(56)
      .backgroundColor(Color.White)
      .padding({ top: this.getUIContext().px2vp(this.topRectHeight) }) // é€‚é…çŠ¶æ€æ 
      .shadow({ radius: 2, color: 'rgba(0,0,0,0.05)', offsetY: 1 }) // åº•éƒ¨åŠ ä¸€ç‚¹ç‚¹é˜´å½±åˆ†å‰²
      .zIndex(1) // ä¿è¯åœ¨æœ€ä¸Šå±‚

      // 2. èŠå¤©å†…å®¹åˆ—è¡¨
      List({ scroller: this.scroller, initialIndex: this.messages.length - 1 }) {
        ForEach(this.messages, (item: ChatMessage, index: number) => {
          ListItem() {
            Row() {
              // --- AI çš„å¤´åƒ (å·¦ä¾§) ---
              if (!item.isSelf) {
                Text('ðŸ¤–') // ç”¨ Emoji ä»£æ›¿å›¾ç‰‡å¤´åƒ
                  .fontSize(24)
                  .width(40)
                  .height(40)
                  .textAlign(TextAlign.Center)
                  .backgroundColor(Color.White)
                  .borderRadius(20)
                  .margin({ right: 10 })
                  .alignSelf(ItemAlign.Start) // å¤´åƒé¡¶å¯¹é½
              } else {
                // å ä½ï¼Œä¿æŒå¸ƒå±€å¹³è¡¡ï¼Œæˆ–è€…ç›´æŽ¥ä¸å†™
                Blank().width(50)
              }

              // --- æ¶ˆæ¯æ°”æ³¡ ---
              Column() {
                Text(item.content)
                  .fontSize(15)
                  .fontColor(item.isSelf ? Color.White : '#333333')
                  .lineHeight(24)
              }
              .backgroundColor(item.isSelf ? '#FF8A3C' : '#FFFFFF') // è‡ªå·±æ˜¯å“ç‰Œè‰²ï¼Œå¯¹æ–¹æ˜¯ç™½è‰²
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              // æ°”æ³¡åœ†è§’å¤„ç†ï¼šè‡ªå·±çš„å³ä¸Šè§’å°–ä¸€ç‚¹ï¼Œå¯¹æ–¹çš„å·¦ä¸Šè§’å°–ä¸€ç‚¹
              .borderRadius({
                topLeft: item.isSelf ? 16 : 4,
                topRight: item.isSelf ? 4 : 16,
                bottomLeft: 16,
                bottomRight: 16
              })
              // åªæœ‰ç™½è‰²çš„æ°”æ³¡åŠ é˜´å½±ï¼Œæ©˜è‰²çš„ä¸ç”¨
              .shadow(item.isSelf ? undefined : {
                radius: 4,
                color: 'rgba(0,0,0,0.05)',
                offsetY: 2
              })
              .layoutWeight(1) // é™åˆ¶æœ€å¤§å®½åº¦
              .constraintSize({ maxWidth: '70%' }) // æ°”æ³¡æœ€å¤§å®½åº¦å å±å¹• 70%
              .alignItems(item.isSelf ? HorizontalAlign.End : HorizontalAlign.Start)

              // --- ç”¨æˆ·çš„å¤´åƒ (å³ä¾§) ---
              if (item.isSelf) {
                Text('ðŸ¤ ') // ç”¨ Emoji ä»£æ›¿ç”¨æˆ·å¤´åƒ
                  .fontSize(24)
                  .width(40)
                  .height(40)
                  .textAlign(TextAlign.Center)
                  .backgroundColor('#FFEFE2') // æ·¡æ©˜è‰²èƒŒæ™¯
                  .borderRadius(20)
                  .margin({ left: 10 })
                  .alignSelf(ItemAlign.Start)
              } else {
                Blank().width(50)
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            // FlexAlign.End è®©è‡ªå·±çš„æ¶ˆæ¯é å³ï¼ŒStart è®©å¯¹æ–¹æ¶ˆæ¯é å·¦
            .justifyContent(item.isSelf ? FlexAlign.End : FlexAlign.Start)
          }
        })
        // åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢æœ€åŽä¸€æ¡æ¶ˆæ¯è¢«è¾“å…¥æ¡†é®æŒ¡
        ListItem().height(20)
      }
      .layoutWeight(1)
      .backgroundColor('#F2F3F5') // èŠå¤©èƒŒæ™¯é€šå¸¸ä½¿ç”¨æµ…ç°è‰²
      .scrollBar(BarState.Off)

      // 3. åº•éƒ¨è¾“å…¥æ 
      Row() {
        // è¾“å…¥æ¡†
        TextInput({
          text: this.inputText,
          placeholder: $r('app.string.ai_service_placeholder')
        })
          .layoutWeight(1)
          .height(40)
          .backgroundColor('#F7F8FA') // æµ…ç°èƒŒæ™¯ï¼ŒåŒºåˆ«äºŽåº•éƒ¨çš„ç™½
          .borderRadius(20)
          .padding({ left: 16, right: 16 })
          .enterKeyType(EnterKeyType.Send) // é”®ç›˜å›žè½¦é”®å˜æˆå‘é€
          .onChange((value: string) => {
            this.inputText = value;
          })
          .onSubmit(() => {
            this.sendMessage();
          })

        // å‘é€æŒ‰é’®
        Button('å‘é€')
          .type(ButtonType.Capsule)
          .backgroundColor(this.inputText.trim().length > 0 ? '#E95B27' : '#FFCBA4') // æœ‰å­—æ—¶æ·±è‰²ï¼Œæ²¡å­—æ—¶æµ…è‰²
          .fontSize(14)
          .height(36)
          .width(70)
          .margin({ left: 12 })
          .enabled(this.inputText.trim().length > 0) // æ²¡å­—ç¦ç”¨
          .onClick(() => {
            this.sendMessage();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 10, bottom: 20 }) // åº•éƒ¨å¤šç•™ç‚¹ç™½ï¼ˆé€‚é…HomeIndicatorï¼‰
      .backgroundColor(Color.White)
      .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: -2 }) // é¡¶éƒ¨é˜´å½±
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F3F5')
  }

  private sendMessage(): void {
    if (!this.inputText || this.inputText.trim().length === 0) {
      try {
        promptAction.showToast({ message: $r('app.string.ai_service_empty') });
      } catch (e) {
        // ignore
      }
      return;
    }

    // 1. æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯
    const selfMsg: ChatMessage = { content: this.inputText.trim(), isSelf: true };
    this.messages.push(selfMsg);

    // æ¸…ç©ºè¾“å…¥æ¡†
    this.inputText = '';

    // 2. æ»šåŠ¨åˆ°åº•éƒ¨
    this.scrollToBottom();

    // 3. æ¨¡æ‹Ÿ AI å›žå¤ (å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œæ›´çœŸå®ž)
    setTimeout(() => {
      const aiMsg: ChatMessage = {
        content: $r('app.string.ai_service_mock_reply'),
        isSelf: false
      };
      this.messages.push(aiMsg);
      this.scrollToBottom();
    }, 500);
  }

  private scrollToBottom() {
    // ä½¿ç”¨ scroller æ»šåŠ¨åˆ°åº•éƒ¨
    this.scroller.scrollEdge(Edge.Bottom);
  }
}