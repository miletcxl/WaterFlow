import { router, window } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { AiService } from '../../common/utils/AiService';

// æ¶ˆæ¯æ•°æ®æ¨¡å‹
class ChatMessage {
  content: string = '';
  isSelf: boolean = false;
}

@Entry
@Component
struct AiServicePage {
  @State messages: ChatMessage[] = [
    { content: 'ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±å¯¼è´­åŠ©æ‰‹ã€‚', isSelf: false },
    { content: 'æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿæˆ‘å¯ä»¥ä¸ºæ‚¨æŸ¥è¯¢è®¢å•ğŸ“¦ã€é¢†å–ä¼˜æƒ åˆ¸ğŸ«æˆ–è§£ç­”å”®åé—®é¢˜ã€‚', isSelf: false }
  ];
  @State inputText: string = '';
  @State isSending: boolean = false;

  // ã€æ ¸å¿ƒã€‘æ‰‹åŠ¨æ§åˆ¶é”®ç›˜é¿è®©é«˜åº¦
  @State keyboardHeight: number = 0;
  // ã€æ ¸å¿ƒã€‘çŠ¶æ€æ é«˜åº¦ï¼ˆé¢„è®¾å€¼ï¼Œç¨åä¼šåŠ¨æ€è·å–ï¼‰
  @State statusBarHeight: number = 38;

  private scroller: Scroller = new Scroller();
  private readonly THEME_COLOR: string = '#FF6B00';
  private readonly BG_COLOR: string = '#F2F3F5';

  // è·å–ä¸Šä¸‹æ–‡
  private context = getContext(this) as common.UIAbilityContext;

  aboutToAppear(): void {
    // 1. è·å–å½“å‰çª—å£å®ä¾‹
    window.getLastWindow(this.context).then((win) => {

      // A. å¼€å¯å…¨å±æ²‰æµ¸å¼ï¼ˆä¸ºäº†å¥½çœ‹ï¼‰ï¼Œä½†æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç•™å‡ºçŠ¶æ€æ ä½ç½®
      win.setWindowLayoutFullScreen(true);

      // B. åŠ¨æ€è·å–çœŸå®çš„çŠ¶æ€æ é«˜åº¦ (é¿è®©åˆ˜æµ·/æŒ–å­”)
      try {
        let area = win.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
        if (area.topRect.height > 0) {
          this.statusBarHeight = px2vp(area.topRect.height);
        }
      } catch (e) {
        // è·å–å¤±è´¥ç”¨é»˜è®¤å€¼
      }

      // C. ã€å…³é”®ã€‘ç›‘å¬é”®ç›˜é«˜åº¦å˜åŒ–
      // æˆ‘ä»¬è‡ªå·±å¤„ç†å¸ƒå±€ï¼Œä¸è®©ç³»ç»Ÿä¹±åŠ¨
      win.on('keyboardHeightChange', (data) => {
        let newHeight = px2vp(data);
        this.keyboardHeight = newHeight;

        // é”®ç›˜å¼¹èµ·æ—¶ï¼Œåˆ—è¡¨æ»šåˆ°åº•éƒ¨
        if (newHeight > 0) {
          setTimeout(() => {
            this.scroller.scrollEdge(Edge.Bottom);
          }, 100);
        }
      });
    });
  }

  aboutToDisappear(): void {
    // ç§»é™¤ç›‘å¬
    window.getLastWindow(this.context).then((win) => {
      win.off('keyboardHeightChange');
    });
  }

  build() {
    // ä½¿ç”¨ Flex å®¹å™¨ï¼Œdirection è®¾ä¸º Column
    // Flex åœ¨å¤„ç†é”®ç›˜æŒ¤å‹æ—¶è¡¨ç°æ›´ç¨³å®š
    Flex({ direction: FlexDirection.Column, alignItems: ItemAlign.Stretch }) {

      // ===============================================
      // 1. é¡¶éƒ¨ Header åŒºåŸŸ (ç»å¯¹å›ºå®šï¼Œä¸å—é”®ç›˜å½±å“)
      // ===============================================
      Column() {
        // 1.1 çŠ¶æ€æ å ä½å±‚ (é«˜åº¦åŠ¨æ€é€‚é…)
        // å®ƒçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†æŠŠæ ‡é¢˜æ â€œé¡¶â€ä¸‹æ¥ï¼Œä¸é®æŒ¡ç”µæ± ä¿¡å·
        Row().height(this.statusBarHeight).width('100%').backgroundColor(this.THEME_COLOR)

        // 1.2 çœŸæ­£çš„æ ‡é¢˜æ å†…å®¹
        this.buildHeaderContent()
      }
      .width('100%')
      .backgroundColor(this.THEME_COLOR)
      .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
      .zIndex(99) // ä¿è¯å±‚çº§æœ€é«˜

      // ===============================================
      // 2. ä¸­é—´æ¶ˆæ¯åˆ—è¡¨ (å¼¹æ€§ä¼¸ç¼©)
      // ===============================================
      // flexGrow(1) ç¡®ä¿å®ƒå æ®å‰©ä½™çš„æ‰€æœ‰ç©ºé—´
      Column() {
        List({ scroller: this.scroller, space: 16 }) {
          // é¡¶éƒ¨çš„ä¸€ç‚¹ç•™ç™½
          ListItem().height(10)

          // å®‰å…¨æç¤º
          ListItem() {
            Row() {
              Text('ğŸ›¡ï¸ å®˜æ–¹è®¤è¯ Â· ä¿¡æ¯åŠ å¯†ä¼ è¾“ä¸­').fontSize(12).fontColor('#999999')
            }
            .width('100%').justifyContent(FlexAlign.Center)
          }

          // æ¶ˆæ¯å¾ªç¯
          ForEach(this.messages, (item: ChatMessage) => {
            ListItem() {
              this.buildMessageItem(item)
            }
          })

          // åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢æœ€åä¸€æ¡æ¶ˆæ¯ç´§è´´è¾“å…¥æ¡†
          ListItem().height(10)
        }
        .width('100%')
        .height('100%')
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .flexGrow(1) // å…³é”®ï¼šé”®ç›˜å‡ºæ¥æ—¶ï¼ŒInputå˜é«˜ï¼Œè¿™ä¸ªåŒºåŸŸè‡ªåŠ¨å˜çŸ®
      .backgroundColor(this.BG_COLOR)

      // ===============================================
      // 3. åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ (éšé”®ç›˜èµ·èˆ)
      // ===============================================
      Column() {
        this.buildInputArea()
      }
      .width('100%')
      .backgroundColor(Color.White)
      // ã€ç»ˆææ–¹æ¡ˆæ ¸å¿ƒã€‘
      // ç»™åº•éƒ¨å®¹å™¨åŠ ä¸€ä¸ª paddingBottomï¼Œæ•°å€¼ç­‰äºé”®ç›˜é«˜åº¦ã€‚
      // è¿™æ ·é”®ç›˜åœ¨ä¸‹é¢å¼¹å‡ºæ¥ï¼Œæˆ‘ä»¬å°±åœ¨ Input ä¸‹é¢å«é«˜åŒæ ·çš„è·ç¦»ã€‚
      // è§†è§‰ä¸Šå°±æ˜¯ Input è¢«é”®ç›˜â€œé¡¶â€ä¸Šæ¥äº†ã€‚
      .padding({ bottom: this.keyboardHeight })
      // åŠ ä¸ŠåŠ¨ç”»ï¼Œè®©å«é«˜çš„è¿‡ç¨‹ä¸æ»‘æµç•…
      .animation({ duration: 250, curve: Curve.EaseOut })

    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.BG_COLOR)
    // ã€é‡è¦ã€‘ä¸ä½¿ç”¨ç³»ç»Ÿçš„ expandSafeArea(KEYBOARD)
    // é˜²æ­¢ç³»ç»ŸæŠŠæ•´ä¸ª Header é¡¶å‡ºå±å¹•
  }

  // --- å†…éƒ¨ UI æ„å»ºæ–¹æ³• ---

  @Builder
  buildHeaderContent() {
    Row() {
      // è¿”å›æŒ‰é’®
      Row() {
        Text('<')
          .fontSize(22)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
          .margin({ top: -2 })
      }
      .width(36)
      .height(36)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('rgba(255,255,255,0.2)')
      .borderRadius(18)
      .onClick(() => {
        router.back();
      })

      // æ ‡é¢˜
      Column() {
        Text('æ™ºèƒ½å®¢æœ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
        Row() {
          Circle({ width: 6, height: 6 }).fill('#44FF99').margin({ right: 4 })
          Text('åœ¨çº¿ä¸­')
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.85)')
        }
        .margin({ top: 2 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .padding({ left: 12 })

      // èœå•
      Text('Â·Â·Â·')
        .fontSize(24)
        .fontColor(Color.White)
        .fontWeight(FontWeight.Bold)
        .padding({ left: 8, right: 4 })
    }
    .width('100%')
    .height(50) // æ ‡é¢˜æ å†…å®¹å›ºå®šé«˜åº¦
    .padding({ left: 12, right: 12 })
  }

  @Builder
  buildMessageItem(item: ChatMessage) {
    Row() {
      if (!item.isSelf) {
        // AI å¤´åƒ
        Text('AI')
          .fontSize(13)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.THEME_COLOR)
          .width(36)
          .height(36)
          .textAlign(TextAlign.Center)
          .backgroundColor(Color.White)
          .borderRadius(18)
          .margin({ right: 10 })
          .shadow({ radius: 4, color: '#0F000000', offsetY: 1 })
      }

      // æ¶ˆæ¯æ°”æ³¡
      Text(item.content)
        .fontSize(15)
        .fontColor(item.isSelf ? Color.White : '#333333')
        .lineHeight(24)
        .padding({ left: 14, right: 14, top: 11, bottom: 11 })
        .backgroundColor(item.isSelf ? this.THEME_COLOR : Color.White)
        .borderRadius({
          topLeft: 12,
          topRight: 12,
          bottomLeft: item.isSelf ? 12 : 2,
          bottomRight: item.isSelf ? 2 : 12
        })
        .constraintSize({ maxWidth: '72%' })
        .shadow({ radius: 2, color: '#0A000000', offsetY: 1 })

      if (item.isSelf) {
        // ç”¨æˆ·å¤´åƒ
        Text('æˆ‘')
          .fontSize(13)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .width(36)
          .height(36)
          .textAlign(TextAlign.Center)
          .backgroundColor('#FFB300')
          .borderRadius(18)
          .margin({ left: 10 })
          .border({ width: 1.5, color: Color.White })
      }
    }
    .width('100%')
    .justifyContent(item.isSelf ? FlexAlign.End : FlexAlign.Start)
    .alignItems(VerticalAlign.Top)
    .padding({ top: 8, bottom: 8 })
  }

  @Builder
  buildInputArea() {
    Row() {
      TextInput({ text: this.inputText, placeholder: 'å’¨è¯¢å®è´è¯¦æƒ…...' })
        .placeholderColor('#999999')
        .caretColor(this.THEME_COLOR)
        .fontSize(15)
        .backgroundColor('#F7F8FA')
        .layoutWeight(1)
        .height(40)
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .enterKeyType(EnterKeyType.Send)
        .enabled(!this.isSending)
        .onChange((value) => {
          this.inputText = value;
        })
        .onSubmit(() => {
          this.sendMessage();
        })

      Button() {
        Text(this.isSending ? 'å‘é€ä¸­' : 'å‘é€')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
      }
      .height(36)
      .width(64)
      .margin({ left: 10 })
      .backgroundColor((this.inputText.trim().length > 0 && !this.isSending) ? this.THEME_COLOR : '#FFD9B3')
      .borderRadius(18)
      .enabled(this.inputText.trim().length > 0 && !this.isSending)
      .onClick(() => {
        this.sendMessage();
      })
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 10, bottom: 12 })
    .shadow({ radius: 10, color: '#0D000000', offsetY: -2 })
  }

  // --- ä¸šåŠ¡é€»è¾‘ ---
  sendMessage() {
    const text = this.inputText.trim();
    if (!text || this.isSending) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.messages.push({ content: text, isSelf: true });
    this.inputText = '';
    this.isSending = true;
    
    // å»¶è¿Ÿæ»šåŠ¨
    setTimeout(() => { this.scroller.scrollEdge(Edge.Bottom); }, 50);

    // æ·»åŠ ä¸€ä¸ªç©ºçš„ AI æ¶ˆæ¯ï¼Œç”¨äºæµå¼æ›´æ–°
    const aiMessageIndex = this.messages.length;
    this.messages.push({ content: '', isSelf: false });

    // è°ƒç”¨ AI æœåŠ¡
    AiService.streamChat(
      text,
      // å†…å®¹å›è°ƒ - æµå¼æ›´æ–°æ¶ˆæ¯
      (content: string) => {
        this.messages[aiMessageIndex].content += content;
        setTimeout(() => { this.scroller.scrollEdge(Edge.Bottom); }, 50);
      },
      // é”™è¯¯å›è°ƒ
      (error: string) => {
        this.messages[aiMessageIndex].content = `âŒ ${error}`;
        this.isSending = false;
      },
      // å®Œæˆå›è°ƒ
      () => {
        this.isSending = false;
        setTimeout(() => { this.scroller.scrollEdge(Edge.Bottom); }, 50);
      }
    );
  }
}