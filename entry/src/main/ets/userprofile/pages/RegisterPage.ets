/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 */

import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction';
import { DatabaseManager } from '../database/DatabaseManager';
import { UserInfo } from '../model/UserInfo';
import { MemberInfo } from '../model/MemberInfo';
import { Order } from '../model/Order';
import Logger from '../../common/utils/Logger';

const TAG = 'RegisterPage';

@Entry
@Component
struct RegisterPage {
  @State username: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State isLoading: boolean = false;
  private context = getContext(this) as common.UIAbilityContext;
  private dbManager: DatabaseManager = DatabaseManager.getInstance();

  aboutToAppear(): void {
    // åˆå§‹åŒ–æ•°æ®åº“
    this.dbManager.initDatabase(this.context).catch((err: BusinessError | Error) => {
      const error = err as Error;
      Logger.error(TAG, `æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨è£…é¥°åŒºåŸŸ
      Column() {
        Text('åˆ›å»ºè´¦æˆ·')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ bottom: 8 })
        Text('æ³¨å†Œæ–°è´¦æˆ·ï¼Œå¼€å¯ç²¾å½©ä¹‹æ—…')
          .fontSize(16)
          .fontColor('rgba(255,255,255,0.9)')
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
      .linearGradient({
        angle: 180,
        colors: [['#FF8A3C', 0.0], ['#FFB36B', 1.0]]
      })
      .borderRadius({ bottomLeft: 30, bottomRight: 30 })

      // æ³¨å†Œè¡¨å•åŒºåŸŸ
      Column() {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        Column() {
          Row() {
            Text('ğŸ‘¤')
              .fontSize(20)
              .margin({ right: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å', text: this.username })
              .layoutWeight(1)
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.username = value;
              })
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .height(56)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .margin({ top: 40, bottom: 16 })

        // å¯†ç è¾“å…¥æ¡†
        Column() {
          Row() {
            Text('ğŸ”’')
              .fontSize(20)
              .margin({ right: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
              .layoutWeight(1)
              .type(InputType.Password)
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.password = value;
              })
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .height(56)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .margin({ bottom: 16 })

        // ç¡®è®¤å¯†ç è¾“å…¥æ¡†
        Column() {
          Row() {
            Text('ğŸ”’')
              .fontSize(20)
              .margin({ right: 12 })
            TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ', text: this.confirmPassword })
              .layoutWeight(1)
              .type(InputType.Password)
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.confirmPassword = value;
              })
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .height(56)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .margin({ bottom: 24 })

        // æ³¨å†ŒæŒ‰é’®
        Button() {
          if (this.isLoading) {
            LoadingProgress()
              .color(Color.White)
              .width(20)
              .height(20)
          } else {
            Text('æ³¨å†Œ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
          }
        }
        .width('100%')
        .height(50)
        .backgroundColor(this.canRegister() ? '#FF6B00' : '#FFD9B3')
        .borderRadius(25)
        .enabled(this.canRegister() && !this.isLoading)
        .onClick(() => {
          this.handleRegister();
        })
        .margin({ bottom: 16 })

        // ç™»å½•é“¾æ¥
        Row() {
          Text('å·²æœ‰è´¦æˆ·ï¼Ÿ')
            .fontSize(14)
            .fontColor('#999999')
          Text('ç«‹å³ç™»å½•')
            .fontSize(14)
            .fontColor('#FF6B00')
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              router.back();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 20 })
      }
      .width('100%')
      .padding({ left: 24, right: 24 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }

  canRegister(): boolean {
    return this.username.trim().length > 0 &&
           this.password.trim().length >= 6 &&
           this.password === this.confirmPassword;
  }

  async handleRegister(): Promise<void> {
    if (!this.canRegister()) {
      if (this.password !== this.confirmPassword) {
        promptAction.showToast({ message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', duration: 2000 });
      } else if (this.password.trim().length < 6) {
        promptAction.showToast({ message: 'å¯†ç é•¿åº¦è‡³å°‘6ä½', duration: 2000 });
      } else {
        promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', duration: 2000 });
      }
      return;
    }

    this.isLoading = true;
    try {
      const userId = await this.dbManager.registerUser(this.username.trim(), this.password.trim());
      
      // åˆ›å»ºé»˜è®¤ç”¨æˆ·ä¿¡æ¯
      const defaultUserInfo = new UserInfo();
      defaultUserInfo.userName = this.username.trim();
      defaultUserInfo.phone = '';
      defaultUserInfo.email = '';
      defaultUserInfo.address = '';
      defaultUserInfo.gender = '';
      defaultUserInfo.birthday = '';
      defaultUserInfo.signature = 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹';
      
      await this.dbManager.saveUserInfo(userId, defaultUserInfo);
      
      // åˆ›å»ºé»˜è®¤ä¼šå‘˜ä¿¡æ¯
      const defaultMemberInfo = new MemberInfo();
      defaultMemberInfo.userId = userId;
      defaultMemberInfo.level = 1;
      defaultMemberInfo.levelName = 'æ™®é€šä¼šå‘˜';
      defaultMemberInfo.points = 100; // æ–°ç”¨æˆ·èµ é€100ç§¯åˆ†
      defaultMemberInfo.monthlySaved = 0;
      await this.dbManager.saveMemberInfo(userId, defaultMemberInfo);
      
      // åˆ›å»ºä¸€äº›ç¤ºä¾‹è®¢å•æ•°æ®
      const sampleOrders: Order[] = [
        {
          orderId: 0,
          userId: userId,
          productName: 'å°ç±³æ— çº¿é¼ æ ‡',
          price: 'ï¿¥79',
          status: 'è¿›è¡Œä¸­',
          orderDate: new Date().toISOString().split('T')[0],
          createTime: Date.now() - 2 * 24 * 60 * 60 * 1000 // 2å¤©å‰
        },
        {
          orderId: 0,
          userId: userId,
          productName: 'å°ç¯é˜…è¯»ç¯',
          price: 'ï¿¥129',
          status: 'å¾…å‘è´§',
          orderDate: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          createTime: Date.now() - 4 * 24 * 60 * 60 * 1000 // 4å¤©å‰
        },
        {
          orderId: 0,
          userId: userId,
          productName: 'å’–å•¡è±† 500g',
          price: 'ï¿¥89',
          status: 'å·²å®Œæˆ',
          orderDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          createTime: Date.now() - 7 * 24 * 60 * 60 * 1000 // 7å¤©å‰
        }
      ];
      
      for (const order of sampleOrders) {
        await this.dbManager.saveOrder(userId, order);
      }
      
      promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸ', duration: 2000 });
      
      // è‡ªåŠ¨ç™»å½•
      const userAccount = await this.dbManager.loginUser(this.username.trim(), this.password.trim());
      if (userAccount) {
        setTimeout(() => {
          router.replaceUrl({
            url: 'pages/HomePage'
          }).catch((err: Error) => {
            Logger.error(TAG, `è·³è½¬é¦–é¡µå¤±è´¥: ${err.message}`);
          });
        }, 500);
      }
    } catch (err) {
      const error = err as Error;
      promptAction.showToast({ message: `æ³¨å†Œå¤±è´¥: ${error.message}`, duration: 2000 });
      Logger.error(TAG, `æ³¨å†Œå¤±è´¥: ${error.message}`);
    } finally {
      this.isLoading = false;
    }
  }
}

