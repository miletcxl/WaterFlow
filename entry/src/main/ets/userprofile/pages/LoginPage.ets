/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 */

import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction';
import { DatabaseManager } from '../database/DatabaseManager';
import Logger from '../../common/utils/Logger';

const TAG = 'LoginPage';

@Entry
@Component
struct LoginPage {
  @State username: string = '';
  @State password: string = '';
  @State isLoading: boolean = false;
  private context = getContext(this) as common.UIAbilityContext;
  private dbManager: DatabaseManager = DatabaseManager.getInstance();

  aboutToAppear(): void {
    // åˆå§‹åŒ–æ•°æ®åº“
    this.dbManager.initDatabase(this.context).catch((err: BusinessError | Error) => {
      const error = err as Error;
      Logger.error(TAG, `æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨è£…é¥°åŒºåŸŸ
      Column() {
        Text('æ¬¢è¿å›æ¥')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ bottom: 8 })
        Text('ç™»å½•æ‚¨çš„è´¦æˆ·ä»¥ç»§ç»­')
          .fontSize(16)
          .fontColor('rgba(255,255,255,0.9)')
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
      .linearGradient({
        angle: 180,
        colors: [['#FF8A3C', 0.0], ['#FFB36B', 1.0]]
      })
      .borderRadius({ bottomLeft: 30, bottomRight: 30 })

      // ç™»å½•è¡¨å•åŒºåŸŸ
      Column() {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        Column() {
          Row() {
            Text('ğŸ‘¤')
              .fontSize(20)
              .margin({ right: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å', text: this.username })
              .layoutWeight(1)
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.username = value;
              })
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .height(56)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .margin({ top: 40, bottom: 16 })

        // å¯†ç è¾“å…¥æ¡†
        Column() {
          Row() {
            Text('ğŸ”’')
              .fontSize(20)
              .margin({ right: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
              .layoutWeight(1)
              .type(InputType.Password)
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.password = value;
              })
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .height(56)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .margin({ bottom: 24 })

        // ç™»å½•æŒ‰é’®
        Button() {
          if (this.isLoading) {
            LoadingProgress()
              .color(Color.White)
              .width(20)
              .height(20)
          } else {
            Text('ç™»å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
          }
        }
        .width('100%')
        .height(50)
        .backgroundColor(this.canLogin() ? '#FF6B00' : '#FFD9B3')
        .borderRadius(25)
        .enabled(this.canLogin() && !this.isLoading)
        .onClick(() => {
          this.handleLogin();
        })
        .margin({ bottom: 16 })

        // æ³¨å†Œé“¾æ¥
        Row() {
          Text('è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ')
            .fontSize(14)
            .fontColor('#999999')
          Text('ç«‹å³æ³¨å†Œ')
            .fontSize(14)
            .fontColor('#FF6B00')
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              router.pushUrl({
                url: 'userprofile/pages/RegisterPage'
              }).catch((err: Error) => {
                Logger.error(TAG, `è·³è½¬æ³¨å†Œé¡µå¤±è´¥: ${err.message}`);
              });
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 20 })
      }
      .width('100%')
      .padding({ left: 24, right: 24 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }

  canLogin(): boolean {
    return this.username.trim().length > 0 && this.password.trim().length > 0;
  }

  async handleLogin(): Promise<void> {
    if (!this.canLogin()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ' });
      return;
    }

    this.isLoading = true;
    try {
      const userAccount = await this.dbManager.loginUser(this.username.trim(), this.password.trim());
      if (userAccount) {
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ', duration: 2000 });
        // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
        setTimeout(() => {
          router.replaceUrl({
            url: 'pages/HomePage'
          }).catch((err: Error) => {
            Logger.error(TAG, `è·³è½¬é¦–é¡µå¤±è´¥: ${err.message}`);
          });
        }, 500);
      } else {
        promptAction.showToast({ message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', duration: 2000 });
      }
    } catch (err) {
      const error = err as Error;
      promptAction.showToast({ message: `ç™»å½•å¤±è´¥: ${error.message}`, duration: 2000 });
      Logger.error(TAG, `ç™»å½•å¤±è´¥: ${error.message}`);
    } finally {
      this.isLoading = false;
    }
  }
}

