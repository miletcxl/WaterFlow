/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 */

import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import promptAction from '@ohos.promptAction';
import { DatabaseManager } from '../database/DatabaseManager';
import { ProfileViewModel } from '../viewmodel/ProfileViewModel';
import Logger from '../../common/utils/Logger';

const TAG = 'EditProfilePage';

@Entry
@Component
struct EditProfilePage {
  @State userName: string = '';
  @State phone: string = '';
  @State email: string = '';
  @State address: string = '';
  @State gender: string = '';
  @State birthday: string = '';
  @State signature: string = '';
  @State isLoading: boolean = false;
  @State isSaving: boolean = false;

  private context = getContext(this) as common.UIAbilityContext;
  private dbManager: DatabaseManager = DatabaseManager.getInstance();
  private viewModel: ProfileViewModel = new ProfileViewModel();

  async aboutToAppear(): Promise<void> {
    try {
      await this.dbManager.initDatabase(this.context);
      await this.viewModel.initUserInfo();
      
      // Âä†ËΩΩÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
      this.userName = this.viewModel.userInfo.userName || '';
      this.phone = this.viewModel.userInfo.phone || '';
      this.email = this.viewModel.userInfo.email || '';
      this.address = this.viewModel.userInfo.address || '';
      this.gender = this.viewModel.userInfo.gender || '';
      this.birthday = this.viewModel.userInfo.birthday || '';
      this.signature = this.viewModel.userInfo.signature || '';
    } catch (err) {
      const error = err as Error;
      Logger.error(TAG, `È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`);
    }
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Row() {
          Text('‚ùÆ')
            .fontSize(22)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ right: 8 })
          Text('ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ')
            .fontSize(18)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .onClick(() => {
          router.back();
        })
        Blank()
        Button() {
          if (this.isSaving) {
            LoadingProgress()
              .color(Color.White)
              .width(16)
              .height(16)
          } else {
            Text('‰øùÂ≠ò')
              .fontSize(16)
              .fontColor(Color.White)
          }
        }
        .type(ButtonType.Normal)
        .backgroundColor(this.isSaving ? '#FFD9B3' : '#FF6B00')
        .borderRadius(20)
        .padding({ left: 20, right: 20, top: 8, bottom: 8 })
        .enabled(!this.isSaving)
        .onClick(() => {
          this.handleSave();
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FF6B00')
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // Ë°®ÂçïÂÜÖÂÆπ
      Scroll() {
        Column() {
          // Áî®Êà∑Âêç
          this.buildInputItem('üë§', 'Áî®Êà∑Âêç', this.userName, (value: string) => {
            this.userName = value;
          })

          // ÊâãÊú∫Âè∑
          this.buildInputItem('üì±', 'ÊâãÊú∫Âè∑', this.phone, (value: string) => {
            this.phone = value;
          })

          // ÈÇÆÁÆ±
          this.buildInputItem('üìß', 'ÈÇÆÁÆ±', this.email, (value: string) => {
            this.email = value;
          })

          // Âú∞ÂùÄ
          this.buildInputItem('üìç', 'Âú∞ÂùÄ', this.address, (value: string) => {
            this.address = value;
          })

          // ÊÄßÂà´ÈÄâÊã©
          Column() {
            Row() {
              Text('‚ößÔ∏è')
                .fontSize(20)
                .margin({ right: 12 })
              Text('ÊÄßÂà´')
                .fontSize(16)
                .fontColor('#333333')
                .layoutWeight(1)
            }
            .width('100%')
            .height(50)
            .padding({ left: 16, right: 16 })
            .alignItems(VerticalAlign.Center)

            Row() {
              this.buildGenderButton('Áî∑', this.gender === 'Áî∑')
              this.buildGenderButton('Â•≥', this.gender === 'Â•≥')
              this.buildGenderButton('‰øùÂØÜ', this.gender === '‰øùÂØÜ' || this.gender === '')
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 16 })
            .justifyContent(FlexAlign.SpaceEvenly)
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ top: 16, bottom: 16 })

          // ÁîüÊó•
          this.buildInputItem('üéÇ', 'ÁîüÊó•ÔºàÊ†ºÂºèÔºöYYYY-MM-DDÔºâ', this.birthday, (value: string) => {
            this.birthday = value;
          })

          // ‰∏™‰∫∫Á≠æÂêç
          Column() {
            Row() {
              Text('‚úçÔ∏è')
                .fontSize(20)
                .margin({ right: 12 })
              Text('‰∏™‰∫∫Á≠æÂêç')
                .fontSize(16)
                .fontColor('#333333')
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 16 })
            .alignItems(VerticalAlign.Center)

            TextArea({ placeholder: 'ËØ∑ËæìÂÖ•‰∏™‰∫∫Á≠æÂêç', text: this.signature })
              .width('100%')
              .height(100)
              .fontSize(15)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .padding(12)
              .onChange((value: string) => {
                this.signature = value;
              })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ top: 16, bottom: 30 })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F6F6F6')
  }

  @Builder
  buildInputItem(icon: string, label: string, value: string, onChange: (value: string) => void) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(20)
          .margin({ right: 12 })
        TextInput({ placeholder: `ËØ∑ËæìÂÖ•${label}`, text: value })
          .layoutWeight(1)
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onChange(onChange)
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ top: 16 })
  }

  @Builder
  buildGenderButton(label: string, isSelected: boolean) {
    Button(label)
      .type(ButtonType.Normal)
      .fontSize(15)
      .fontColor(isSelected ? Color.White : '#666666')
      .backgroundColor(isSelected ? '#FF6B00' : '#F5F5F5')
      .borderRadius(20)
      .width(100)
      .height(40)
      .onClick(() => {
        this.gender = label;
      })
  }

  async handleSave(): Promise<void> {
    this.isSaving = true;
    try {
      const currentUser = await this.dbManager.getCurrentUser();
      if (!currentUser) {
        promptAction.showToast({ message: 'Áî®Êà∑Êú™ÁôªÂΩï', duration: 2000 });
        return;
      }

      // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
      this.viewModel.userInfo.userName = this.userName.trim();
      this.viewModel.userInfo.phone = this.phone.trim();
      this.viewModel.userInfo.email = this.email.trim();
      this.viewModel.userInfo.address = this.address.trim();
      this.viewModel.userInfo.gender = this.gender;
      this.viewModel.userInfo.birthday = this.birthday.trim();
      this.viewModel.userInfo.signature = this.signature.trim();

      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      await this.viewModel.saveUserInfo();
      
      promptAction.showToast({ message: '‰øùÂ≠òÊàêÂäü', duration: 2000 });
      
      // Âª∂ËøüËøîÂõûÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊèêÁ§∫
      setTimeout(() => {
        router.back();
      }, 500);
    } catch (err) {
      const error = err as Error;
      promptAction.showToast({ message: `‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, duration: 2000 });
      Logger.error(TAG, `‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
    } finally {
      this.isSaving = false;
    }
  }
}

